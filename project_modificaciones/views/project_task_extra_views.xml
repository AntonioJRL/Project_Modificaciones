<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="project_task_form_inherit" model="ir.ui.view">
        <field name="name">project.task.form.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2" />
        <field name="arch" type="xml">

            <xpath expr="//sheet//div" position="inside">
                <button class="oe_stat_button" type="object" name="action_view_avances"
                    icon="fa-file-text" title="Ver Avances">
                    <field name="updates_count" string="Avances" widget="statinfo" />
                </button>
            </xpath>

            <!--Boton
            Iniciar en Tarea Invisible cuando es tarea de obra-->
            <xpath expr="//header/button[@name='action_timer_start']" position="attributes">
                <attribute name="invisible">is_control_obra == True</attribute>
            </xpath>

            <xpath expr="//sheet//field[@name='tag_ids']" position="after">
                <field name="partida_relacionada" />
            </xpath>
            <xpath expr="//div[@id='date_deadline_and_recurring_task']" position="after">
                <field name="tarea_padre" invisible="[('parent_id', '=', False)]" />
            </xpath>

            <xpath expr="//field[@name='project_id'][@widget='project']" position="before">
                <field name="project_domain_string" invisible="1" />
            </xpath>

            <xpath expr="//field[@name='project_id'][@widget='project']" position="attributes">
                <attribute name="domain">project_domain_string</attribute>
            </xpath>

            <!--###################################################################################-->
            <xpath expr="//header/field[@name='personal_stage_type_id']" position="before">

                <field name="can_user_approve" invisible="1" />

                <button name="action_send_for_approval" string="Enviar a Aprobación"
                    type="object" class="oe_highlight"
                    invisible="approval_state not in ['draft'] or is_control_obra == False" />

                <button name="action_approve" string="Aprobar Tarea"
                    type="object" class="oe_highlight"
                    invisible="not can_user_approve or approval_state != 'to_approve' or is_control_obra == False" />

                <button name="action_reject" string="Rechazar Tarea"
                    type="object" class="btn-secondary"
                    invisible="not can_user_approve or approval_state != 'to_approve' or is_control_obra == False" />

                <button name="action_draft" string="Borrador"
                    type="object" class="oe_highlight"
                    invisible="not can_user_approve or approval_state in ['to_approve', 'draft', 'approved'] or is_control_obra == False" />

                <field name="approval_state" widget="statusbar"
                    statusbar_visible="draft,to_approve,approved"
                    invisible="is_control_obra == False" />
            </xpath>

            <xpath expr="//field[@name='name']" position="attributes">
                <attribute name="readonly">approval_state not in ['draft', 'rejected']</attribute>
            </xpath>

            <xpath expr="//field[@name='stage_id']" position="attributes">
                <attribute name="invisible">is_control_obra == True</attribute>
            </xpath>
            <!--###################################################################################-->

            <xpath expr="//group" position="after">
                <separator string="Avance" name="separador_avance" />
                <group name="Avance">
                    <group>
                        <field name="use_weighted_progress" widget="boolean_toggle" />
                        <field name="subtask_weight" invisible="not parent_id" />
                        <field name="progress" widget="progressbar" />
                        <field name="quant_progress" />
                        <field name="is_complete" string="¿Tarea terminada?" />
                    </group>
                    <group>
                        <field name="sale_order_id" string="Venta" />
                        <field name="total_pieces" />
                        <field name="piezas_pendientes" />
                        <field name="disc" string="Especialidad" />
                    </group>
                </group>
                <separator string="Actividad reciente" />
                <group>
                    <field name="last_update" string="Última actualización" invisible="0" />
                    <field name="last_d_update" string="Última modificación" />
                    <field name="last_update_date" />
                </group>
            </xpath>
            <xpath expr="//field[@name='child_ids']/tree/field[@name='name']" position="after">
                <field name="subtask_weight" sum="Total Peso" />
                <field name="quant_progress" sum="Total Avance" string="U. Entregadas" />
                <field name="progress" widget="progressbar" string="Avance (%)" />
            </xpath>

            <xpath expr="//page[@name='sub_tasks_page']" position="after">
                <page name="updates" string="Actualizaciones">
                    <field name="sub_update_ids" readonly="True">
                        <form class="control_de_obra_view" string="Avance">
                            <header>
                                <field name="avances_state" widget="statusbar" readonly="1" />
                                <button name="action_confirmado_avances" type="object"
                                    string="Confirmar Avance"
                                    class="oe_highlight" invisible="avances_state != 'draft'"
                                    groups="project_modificaciones.group_botones_avance" />

                                <button name="action_revert_avances_to_draft" type="object"
                                    string="Revertir a Borrador"
                                    class="btn-secondary"
                                    invisible="avances_state == 'draft'"
                                    groups="project_modificaciones.group_boton_borrador_avance" /> <!--invisible="avances_state
                                != 'confirmed'"-->

                                <button name="toggle_asignar_avance" string="Asignar Avance"
                                    type="object"
                                    class="oe_highlight"
                                    invisible="asignar_avance or avances_state == 'assigned'"
                                    groups="project_modificaciones.group_botones_avance" />

                                <button name="toggle_asignar_avance" string="No Asignar Avance"
                                    type="object"
                                    invisible="not asignar_avance"
                                    groups="project_modificaciones.group_botones_avance" />

                            </header>
                            <sheet>
                                <field name="cliente" invisible="1" />
                                <field name="asignar_avance" invisible="1" />
                                <div class="oe_title">
                                    <h1 class="d-flex flex-row">
                                        <field name="name" />
                                    </h1>
                                </div>

                                <separator string="Datos Internos del Servicio" />
                                <group>
                                    <group>
                                        <field name="sale_order_id" />
                                    </group>
                                    <group>
                                        <field name="project_id" readonly="not asignar_avance"
                                            domain="[('is_proyecto_obra', '=', True)]" />
                                    </group>
                                </group>
                                <h4>
                                    <field name="task_id" string="Partida"
                                        placeholder="Seleccione La Tarea"
                                        style="width: 100%"
                                        options="{'no_create': True}"
                                        readonly="avances_state in 'assigned'" />
                                </h4>
                                <group>
                                    <group>
                                        <field name="cliente_project" options="{'no_open': True}" />
                                        <field name="especialidad" widget="many2many_tags"
                                            options="{'no_open': True, 'color_field': 'color'}" />
                                    </group>
                                    <group>
                                        <field name="update_id"
                                            domain="[('project_id', '=', project_id), ('sub_update_ids', '=', False)]"
                                            context="{'default_project_id': project_id}"
                                            readonly="avances_state == 'assigned'" />
                                        <field name="ultima_actualizacion" readonly="True"
                                            invisible="avances_state == 'assigned'" />
                                    </group>
                                </group>

                                <style>
                                    .o_form_view .o_cell.o_wrap_label .o_form_label[for="ct_0"],
                                    .o_form_view .o_cell.o_wrap_label
                                    .o_form_label[for="producto_0"],
                                    .o_form_view .o_cell.o_wrap_label .o_form_label[for="planta_0"],
                                    .o_form_view .o_cell.o_wrap_label
                                    .o_form_label[for="hora_inicio_0"],
                                    .o_form_view .o_cell.o_wrap_label
                                    .o_form_label[for="hora_termino_0"],
                                    .o_form_view .o_cell.o_wrap_label
                                    .o_form_label[for="supervisorplanta_0"],
                                    .o_form_view .o_cell.o_wrap_label
                                    .o_form_label[for="responsible_id_0"],
                                    .o_form_view .o_cell.o_wrap_label
                                    .o_form_label[for="licencia_0"],
                                    .o_form_view .o_cell.o_wrap_label
                                    .o_form_label[for="update_id_0"],
                                    .o_form_view .o_cell.o_wrap_label
                                    .o_form_label[for="unit_progress_0"] {
                                    color: #FF0000 !important;
                                    font-weight: bold !important;
                                    }

                                    .o_form_view input#ct_0,
                                    .o_form_view input#producto_0,
                                    .o_form_view input#planta_0,
                                    .o_form_view input#hora_inicio_0,
                                    .o_form_view input#hora_termino_0,
                                    .o_form_view input#supervisorplanta_0,
                                    .o_form_view input#responsible_id_0,
                                    .o_form_view input#licencia_0,
                                    .o_form_view input#update_id_0,
                                    .o_form_view input#unit_progress_0 {
                                    border: none !important;
                                    border-bottom: 1px solid #FF0000 !important;
                                    border-radius: 0 !important;
                                    box-shadow: none !important;
                                    background: linear-gradient(to bottom, transparent 96%, #FF0000
                                    96%) !important;
                                    padding-bottom: 0px !important;
                                    }
                                </style>

                                <separator string="Información Producto A Entregar" />
                                <group>
                                    <group>
                                        <field name="producto"
                                            placeholder="Seleccionar El Producto A Trabajar"
                                            readonly="avances_state != 'draft'" />
                                        <field name="unidad_medida" />
                                    </group>
                                    <group>
                                        <field name="especialidad_producto" />
                                        <field name="precio_unidad" />
                                    </group>
                                </group>

                                <separator string="Datos Generales Del Avance" />
                                <group>
                                    <group>
                                        <field name="oc_pedido" />
                                        <field name="ct"
                                            options="{'no_quick_create': True, 'no_create_edit': False}"
                                            readonly="avances_state != 'draft'" />
                                        <field name="especialidad_trabajo" />
                                    </group>

                                    <group>
                                        <field name="date" readonly="avances_state != 'draft'" />
                                        <field name="or_rfq" readonly="avances_state in 'assigned'" />
                                        <field name="no_cotizacion"
                                            readonly="avances_state in 'assigned'" />
                                    </group>
                                </group>

                                <separator string="Descripción Detallada Del Avance" />
                                <group>
                                    <field name="planta"
                                        options="{'no_quick_create': False, 'no_create_edit': True}"
                                        context="{'default_cliente': cliente}"
                                        readonly="avances_state != 'draft'" />
                                </group>
                                <group>
                                    <group>
                                        <field name="hora_inicio" widget="datetime"
                                            readonly="avances_state != 'draft'" />
                                        <separator string="Responsable Cliente" widget="badge" />
                                        <field name="supervisorplanta" widget="many2one_avatar_user"
                                            options="{'no_quick_create': True, 'no_create_edit': True}"
                                            context="{'default_cliente': cliente , 'show_address': False, 'show_name_only': True}"
                                            readonly="avances_state != 'draft'" />
                                        <!--Cliente-->
                                        <field name="area_equipo"
                                            readonly="avances_state != 'draft'" />
                                    </group>
                                    <group>
                                        <field name="hora_termino" widget="datetime"
                                            readonly="avances_state != 'draft'" />
                                        <separator string="Responsable Interno" widget="badge" />
                                        <field name="responsible_id" widget="many2one_avatar_user"
                                            options="{'no_quick_create': True, 'no_create_edit': True}"
                                            readonly="avances_state != 'draft'" />
                                        <!--Ayasa-->
                                        <field name="licencia" widget="many2one"
                                            readonly="avances_state in 'assigned'" />
                                    </group>
                                </group>

                                <separator string="Avance Actual" />
                                <group>
                                    <group>
                                        <field name="unit_progress" widget="float" digits="[12,6]"
                                            readonly="avances_state != 'draft'" />
                                        <field name="virtual_quant_progress"
                                            string="Unidades entregadas" widget="float"
                                            digits="[12,6]" />
                                    </group>
                                    <group>
                                        <field name="actual_progress_percentage" widget="percentage" />
                                        <field name="missing_quant" digits="[12,6]" />
                                        <field name="proj" invisible="1" />
                                        <field name="projid" invisible="1" />
                                        <field name="projname" invisible="1" />
                                    </group>
                                </group>

                                <separator string="Avance del servicio" />
                                <group>
                                    <group>
                                        <field name="estado" invisible="1" />
                                        <field name="virtual_quant_progress"
                                            string="Unidades entregadas"
                                            digits="[12,6]" />
                                        <field name="sale_current" />
                                    </group>
                                    <group>
                                        <field name="quant_total" string="Unidades a entregar"
                                            widget="float"
                                            digits="[12,6]" />
                                        <field name="virtual_total_progress" string="Progreso total"
                                            widget="progressbar" />
                                    </group>
                                </group>
                                <group>
                                    <group>
                                        <field name="costo_avance_formateado" />
                                    </group>
                                </group>
                                <!-- Campos de dominio eliminados para evitar problemas con IDs
                                inválidos -->

                                <separator string="Estado de la facturacion" />
                                <group>
                                    <group>
                                        <field name="bitacorapmv"
                                            readonly="avances_state in 'assigned'" />
                                        <!--<field
                                        name="numlic" string="#Bitacora/Licencia"
                                            readonly="avances_state in 'assigned'" />-->
                                        <field name="estimado"
                                            readonly="avances_state in 'assigned'" /> <!--readonly="0"-->
                                        <field name="datefact"
                                            readonly="avances_state in 'assigned'" /> <!--readonly="0"-->
                                        <field name="is_invoiced" invisible="1" />
                                        <field name="sale_total" />
                                    </group>
                                    <group>
                                        <field name="om" readonly="avances_state in 'assigned'" />
                                        <field name="cot" readonly="avances_state in 'assigned'" />
                                        <field name="avanceparc"
                                            readonly="avances_state in 'assigned'" /> <!--readonly="0"-->
                                        <field name="factura"
                                            options="{'no_edit': True, 'no_create': True}"
                                            readonly="avances_state in 'assigned'" /> <!--readonly="0"-->
                                        <field name="sale_actual" />
                                        <field name="sale_missing" />
                                    </group>

                                    <field name="domain" invisible="1" />

                                </group>
                                <separator string="Seguimiento" />
                                <group>
                                    <field name="notas" string="Comentarios Pertinentes:" />
                                </group>
                                <group>
                                    <group>
                                        <field name="write_date" string="Modificado por ult. vez" />
                                        <field name="is_transferible" widget="boolean_toggle"
                                            readonly="1"
                                            invisible="1" />
                                    </group>
                                    <group>
                                        <field name="created_by" widget="many2one_avatar_user"
                                            options="{'no_create': True}" />
                                        <field name="is_avance_preliminar" widget="boolean_toggle"
                                            readonly="1"
                                            invisible="1" />
                                    </group>
                                </group>
                            </sheet>
                        </form>
                        <tree default_order="id desc">
                            <field name="update_id" optional="show" />
                            <field name="project_id" optional="show" />
                            <field name="name" optional="show" string="Avance" />
                            <field name="date" string="Elaborado" />
                            <field name="responsible_id" string="Supv. Interno" />
                            <field name="avances_state" widget="badge"
                                decoration-success="avances_state == 'assigned' or avances_state == 'done'"
                                decoration-info="avances_state == 'confirmed'"
                                decoration-warning="avances_state == 'draft'" optional="show" />
                            <field name="unit_progress" string="Avance de unidades" optional="hide" />
                            <field name="virtual_quant_progress" string="Unidades entregadas"
                                optional="hide" />
                            <field name="actual_progress_percentage" widget="percentage"
                                optional="hide" />
                            <field name="total_progress_percentage" string="Progreso total"
                                widget="percentage"
                                optional="show" />
                        </tree>
                    </field>
                </page>
            </xpath>

            <xpath expr="//separator[@name='separador_avance']" position="before">
                <separator string="Datos Generales" name="separador_general" />
                <group name="datos_general">
                    <group>
                        <field name="centro_trabajo"
                            readonly="approval_state in ['to_approve', 'approved']"
                            help="Selecciona la ubicación física principal donde se ejecutará el servicio." />

                        <field name="supervisor_interno"
                            widget="many2one_avatar_user"
                            readonly="approval_state in ['to_approve', 'approved']" />
                    </group>
                    <group>
                        <field name="planta_trabajo"
                            help="Indica la planta específica dentro del Centro de Trabajo donde se realizará la actividad."
                            readonly="approval_state in ['to_approve', 'approved']"
                        />
                        <field name="supervisor_cliente" widget="many2one_avatar_user"
                            help="Persona de contacto (cliente) que supervisará y validará los trabajos en sitio."
                            readonly="approval_state in ['to_approve', 'approved']"
                        />
                        <field name="is_control_obra" widget="boolean_toggle" readonly="1" />
                        <field name="producto_relacionado" invisible="1" />
                    </group>
                </group>
            </xpath>
        </field>
    </record>

    <record id="project_task_view_search_inherit" model="ir.ui.view">
        <field name="name">project.task.view.search.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_search_form" />
        <field name="arch" type="xml">
            <xpath expr="//field[@name='stage_id']" position="after">
                <filter name="state" string="Estado" context="{'group_by': 'state'}" />
                <filter name="pendiente_orden" string="No asignados"
                    domain="[('sale_line_id', 'not ilike', '')]" />
                <filter name="con_orden" string="Asignados" domain="[('sale_line_id', '!=', False)]" />
            </xpath>
        </field>
    </record>

    <!--VISTA
    ORIGINAL NADA MAS SE AGREGO EL DOMINIO-->
    <record id="project.action_view_all_task" model="ir.actions.act_window">
        <field name="domain">[('project_id.is_proyecto_obra', '=', False)]</field>
    </record>
    <record id="project.action_view_my_task" model="ir.actions.act_window">
        <field name="domain">[('project_id.is_proyecto_obra', '=', False)]</field>
    </record>

    <record id="view_task_kanban_control_obra" model="ir.ui.view">
        <field name="name">project.task.kanban.control.obra</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_kanban" />
        <field name="arch" type="xml">

            <xpath expr="//field[@name='name']" position="after">
                <div class="d-flex align-items-center mt-2 mb-2">
                    <span class="text-muted small me-2"
                        style="white-space: nowrap; font-weight: bold;">
                        Progreso:
                    </span>
                    <field name="progress" widget="progressbar" />
                </div>
            </xpath>
        </field>
    </record>

    <record id="open_task" model="ir.actions.act_window">
        <field name="name">Tareas de Obra</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">tree,form,kanban</field>
        <field name="domain">[
            ("project_id", "!=", False),
            ("project_id.is_proyecto_obra", "=", True)
            ]
        </field>
        <field name="context"
            eval="{
            'group_by': 'state',
            'create': True,
            'default_is_control_obra': True,
            }" />
        <field name="groups_id" eval="[(4, ref('project.group_project_stages'))]" />
        <field name="view_ids"
            eval="[
            (5, 0, 0),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('project.view_task_tree2')}),
            (0, 0, {'view_mode': 'kanban', 'view_id': ref('project_modificaciones.view_task_kanban_control_obra')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('project.view_task_form2')})
        ]" />
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No se encontraron Tareas. ¡Creemos una!
            </p>
        </field>
    </record>

    <!-- Archivo: c:\Users\Erick\Downloads\rev\project_modificaciones\views\project_task_views.xml -->
    <record id="view_project_task_form_inherit_sale_line" model="ir.ui.view">
        <field name="name">project.task.form.inherit.sale.line</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2" />
        <field name="arch" type="xml">
            <!-- Insertamos el campo justo después del campo “Nombre” -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="sale_line_id"
                    string="Línea de venta"
                    domain="[('order_id', '=', sale_order_id), ('is_service', '=', True)]"
                    options="{'no_create': True}"
                    help="Selecciona la línea de la orden de venta que corresponde a esta tarea."
                    context="{'default_order_id': sale_order_id}" />
            </xpath>
            <!-- Botón opcional para abrir el wizard de enlace -->
            <xpath expr="//header" position="inside">
                <button name="action_link_sale_line"
                    type="object"
                    string="Vincular línea"
                    class="oe_highlight"
                    invisible="sale_line_id != False" />
            </xpath>
        </field>
    </record>
</odoo>